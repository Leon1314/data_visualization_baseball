<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>

    h2,h3{
      text-align: center;
    }

    body{
      text-align: center;
      font: 12px sans-serif;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .dot,.legend rect{
      opacity: 0.4;
    }

    div.handedness_button{
      position: fixed;
      top: 100px;
      right: 200px;
    }

    div.handedness_button div{
      background-color: rgb(251,201,127);
      padding: 3px;
      margin: 7px;
    }

    .note{
      color: gray;
      font: 12px sans-serif;
    }

    .information{
      color: black;
      font: 12px sans-serif;
    }


    </style>

    <script type="text/javascript">
      function draw(data) {

      //set svg size
      var margin = {top: 50, right: 20, bottom: 30, left: 40},
      width = 1200 - margin.left - margin.right,
      height = 700 - margin.top - margin.bottom;

      //Set title.
      d3.select("body")
        .append("h2")
        .text("棒球选手全垒打得分、击球率与身高、体重、用手习惯的关系")

      d3.select("body")
        .append("h3")

      //find range of x axis.
      var x = d3.scale.linear()
      .range([0, width]);


      //find range of x axis.
      var y = d3.scale.linear()
      .range([height, 0]);


      // set ellipse color range
      var color = d3.scale.category10();

      // Create ellipse size scale
      var rx = d3.scale.sqrt()
      .range([2,6]);

      var ry = d3.scale.sqrt()
      .range([2,6]);

      var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

      var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");

      var svg = d3.select("body")
        .append("svg")
          .attr("width", width + margin.left+ margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


      x.domain(d3.extent(data, function(d) { return d.height; })).nice();
      y.domain(d3.extent(data, function(d) { return d.weight; })).nice();
      rx.domain(d3.extent(data, function(d) { return d.HR; })).nice();
      ry.domain(d3.extent(data, function(d) { return d.avg; })).nice();


      var handed = ["Right hand", "Left hand", "Both hand", "All"];

      
      // set x axis
      svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width)
          .attr("y", -6)
          .style("text-anchor", "end")
          .text("height ( inch )");

      // set y axis
      svg.append("g")
          .attr("class", "y axis")
          .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("weight ( pound )")


      // 设置画椭圆的函数
      function draw_point(draw_data){
        svg.selectAll("ellipse").remove();

        svg.selectAll(".dot")
        .data(draw_data)
        .enter()
        .append("ellipse")
        .attr("class", "dot")
        .attr("cx", function(d){return x(d.height); })
        .attr("cy", function(d){return y(d.weight); })
        .attr("rx",  function(d){return rx(d.HR); })
        .attr("ry",  function(d){return ry(d.avg); })
        .style("fill", function(d){return color(d.handedness);})
        .on("mouseover", handleMouseOver)
        .on("mouseout", handleMouseOut);
      };

      // 鼠标悬浮在椭圆上方时，显示该椭圆的相关信息
      function handleMouseOver(d, i){
          
        d3.select(this)
          .style("rx", function(d){return rx(d.HR)*2; })
          .style("ry", function(d){return ry(d.avg)*2; });
        
        svg.append("text")
        .attr("id", "information")
        .attr("x", function(){return x(d.height)-50; })
        .attr("y", function(){return y(d.weight)-15; })
        .text(function(){
          var height = "height:" + d.height;
          var weight = "weight:" + d.weight;
          var avg = "avg:" + d.avg;
          var HR = "HR:" + d.HR;
          var str = String(height) + "\t" + String(weight) + "\t" + String(avg) + "\t" + String(HR);

          return str;
        });
      }

      // 鼠标移开时删除多余的信息
      function handleMouseOut(d, i){
        d3.select(this)
        .style("rx", function(d){return rx(d.HR); })
        .style("ry", function(d){return ry(d.avg); });

        d3.selectAll("#information").remove();
      }

      //画出所有的椭圆
      draw_point(data);


      // 设置图例
      var legend = svg.selectAll(".legend")
      .data(color.domain())
      .enter()
      .append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i){return "translate(0," + i * 20 + ")"; });

      legend.append("rect")
          .attr("x", width - 35)
          .attr("width", 18)
          .attr("height", 18)
          .style("fill", color);

      legend.append("text")
          .attr("x", width - 40)
          .attr("y", 9)
          .attr("dy", ".35em")
          .style("text-anchor", "end")
          .text(function(d) { 
            if (d == "R"){
              return "Right hand";
            }
            if (d == "L") {
              return "Left hand";
            }
            else {
              return "Both hand"
            };

          });

      d3.select("body")
        .append("div")
        .attr("class", "note")
        .text("备注：椭圆横向半径代表全垒得分大小，纵向半径代表击球率大小。")

      //添加按钮
      var buttons = d3.select("body")
      .append("div")
      .attr("class", "handedness_button")
      .selectAll("div")
      .data(handed)
      .enter()
      .append("div")
      .text(function(d){
        return d;
      });

      // 设置点击事件
      buttons.on("click", function(d){
        d3.select(".handedness_button")
          .selectAll("div")
          .transition()
          .duration(500)
          .style("color", "black")
          .style("background", "rgb(251, 201, 127)");
          
        d3.select(this)
          .transition()
          .duration(500)
          .style("background", "lightBlue")
          .style("color", "white");
        update(d);
      });


      // 设置update函数，当点击按钮时，会按照此函数刷新数据
      function update(handedness) {

        if (handedness == "Right hand") {
          hand = "R";
        } 
        else if (handedness == "Left hand") {
          hand = "L";
        } 
        else if (handedness == "Both hand") {
          hand = "B";
        } 
        else { 
          hand = "All";
        }
        
        function filtered(tmp_data){
          return data.filter(function(d){
            return d.handedness == tmp_data;
        });}

        if (hand == "All"){
          draw_point(data);
        }
        else {
          draw_point(filtered(hand));
        }
      }

    }


    </script>
  </head>
<body>
  <script type="text/javascript">

  d3.csv("baseball_data.csv",draw);

  </script>
</body>
</html>
